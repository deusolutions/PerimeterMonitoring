{% extends "base.html" %}

{% block title %}IP-адреса{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Мониторинг IP-адресов</h4>
            <div>
                <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addIpModal">
                    <i class="fas fa-plus"></i> Добавить
                </button>
                <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#importIpsModal">
                    <i class="fas fa-file-import"></i> Импорт
                </button>
                <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Фильтры
                </button>
                <div class="dropdown-menu p-3" aria-labelledby="filterDropdown" style="width: 250px;">
                    <form action="{{ url_for('ip_addresses_page') }}" method="get">
                        <div class="mb-3">
                            <label class="form-label">Статус:</label>
                            <select name="status" class="form-select form-select-sm">
                                <option value="">Все</option>
                                <option value="active">Активные</option>
                                <option value="inactive">Неактивные</option>
                                <option value="changed">Изменившиеся</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Группа:</label>
                            <select name="group" class="form-select form-select-sm">
                                <option value="">Все</option>
                                {% for group in ip_groups %}
                                    <option value="{{ group.id }}">{{ group.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm w-100">Применить</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="card-body">
            {% if ip_addresses %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>IP-адрес</th>
                                <th>Группа</th>
                                <th>Описание</th>
                                <th>Статус</th>
                                <th>Последняя проверка</th>
                                <th>Последнее изменение</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ip in ip_addresses %}
                            <tr class="{% if ip.has_recent_changes %}table-warning{% endif %}">
                                <td>{{ ip.address }}</td>
                                <td>{{ ip.group }}</td>
                                <td>{{ ip.description }}</td>
                                <td>
                                    {% if ip.is_active %}
                                        <span class="badge bg-success">Активен</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Неактивен</span>
                                    {% endif %}
                                    {% if ip.has_recent_changes %}
                                        <span class="badge bg-warning">Изменения</span>
                                    {% endif %}
                                </td>
                                <td>{{ ip.last_check }}</td>
                                <td>{{ ip.last_change if ip.last_change else 'Н/Д' }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('ip_details', ip_id=ip.id) }}" class="btn btn-outline-primary">Детали</a>
                                        <button type="button" class="btn btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                            <span class="visually-hidden">Toggle Dropdown</span>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="{{ url_for('force_check_ip', ip_id=ip.id) }}">Проверить</a></li>
                                            <li><a class="dropdown-item" href="{{ url_for('edit_ip', ip_id=ip.id) }}">Редактировать</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteIpModal" data-ip-id="{{ ip.id }}" data-ip-address="{{ ip.address }}">Удалить</a></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Пагинация -->
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        <li class="page-item {% if not prev_page %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('ip_addresses_page', page=prev_page) if prev_page else '#' }}" tabindex="-1" aria-disabled="{{ 'true' if not prev_page else 'false' }}">Предыдущая</a>
                        </li>
                        {% for p in range(1, total_pages + 1) %}
                            <li class="page-item {% if p == current_page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('ip_addresses_page', page=p) }}">{{ p }}</a>
                            </li>
                        {% endfor %}
                        <li class="page-item {% if not next_page %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('ip_addresses_page', page=next_page) if next_page else '#' }}">Следующая</a>
                        </li>
                    </ul>
                </nav>
            {% else %}
                <div class="alert alert-info text-center">
                    IP-адресов не найдено
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal для добавления нового IP-адреса -->
<div class="modal fade" id="addIpModal" tabindex="-1" aria-labelledby="addIpModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addIpModalLabel">Добавить IP-адрес для мониторинга</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addIpForm" action="{{ url_for('add_ip_address') }}" method="post">
                    <div class="mb-3">
                        <label for="ip_address" class="form-label">IP-адрес</label>
                        <input type="text" class="form-control" id="ip_address" name="ip_address" placeholder="192.168.1.1" required>
                    </div>
                    <div class="mb-3">
                        <label for="ip_group" class="form-label">Группа</label>
                        <select class="form-select" id="ip_group" name="ip_group">
                            <option value="">Без группы</option>
                            {% for group in ip_groups %}
                                <option value="{{ group.id }}">{{ group.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Описание</label>
                        <input type="text" class="form-control" id="description" name="description" placeholder="Назначение IP-адреса">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="check_now" name="check_now" checked>
                        <label class="form-check-label" for="check_now">Проверить сразу после добавления</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="submit" form="addIpForm" class="btn btn-primary">Добавить</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal для импорта IP-адресов -->
<div class="modal fade" id="importIpsModal" tabindex="-1" aria-labelledby="importIpsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importIpsModalLabel">Импорт IP-адресов</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="importIpsForm" action="{{ url_for('import_ip_addresses') }}" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="ip_file" class="form-label">Файл с IP-адресами (CSV или TXT)</label>
                        <input type="file" class="form-control" id="ip_file" name="ip_file" accept=".csv,.txt" required>
                        <div class="form-text">Файл должен содержать IP-адреса, по одному на строку или в формате CSV.</div>
                    </div>
                    <div class="mb-3">
                        <label for="import_group" class="form-label">Добавить в группу</label>
                        <select class="form-select" id="import_group" name="import_group">
                            <option value="">Без группы</option>
                            {% for group in ip_groups %}
                                <option value="{{ group.id }}">{{ group.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="check_imported" name="check_imported" checked>
                        <label class="form-check-label" for="check_imported">Проверить IP-адреса после импорта</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="submit" form="importIpsForm" class="btn btn-primary">Импортировать</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal для удаления IP-адреса -->
<div class="modal fade" id="deleteIpModal" tabindex="-1" aria-labelledby="deleteIpModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteIpModalLabel">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить IP-адрес <span id="ipAddressToDelete"></span> из системы мониторинга?</p>
                <p class="text-danger">Это действие нельзя отменить.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <form id="deleteIpForm" action="" method="post">
                    <button type="submit" class="btn btn-danger">Удалить</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const deleteIpModal = document.getElementById('deleteIpModal');
        if (deleteIpModal) {
            deleteIpModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const ipId = button.getAttribute('data-ip-id');
                const ipAddress = button.getAttribute('data-ip-address');
                
                document.getElementById('ipAddressToDelete').textContent = ipAddress;
                document.getElementById('deleteIpForm').action = "{{ url_for('delete_ip_address', ip_id='') }}" + ipId;
            });
        }
    });
</script>
{% endblock %}
{% endblock %}