# Документация системы мониторинга внешнего периметра

## Архитектура системы

Система мониторинга внешнего периметра построена на модульной архитектуре, что обеспечивает гибкость, расширяемость и возможность интеграции с различными сервисами. Основа системы – главный координатор (`main.py`), который управляет всеми компонентами системы.

### Основные компоненты

1. **Модули мониторинга** - отдельные компоненты, отвечающие за конкретные задачи мониторинга:
   - `ip_scanner.py` - сканирование и анализ IP-адресов
   - `website_monitor.py` - проверка доступности и изменений на веб-сайтах
   - `cert_checker.py` - проверка SSL-сертификатов
   - `port_scanner.py` - сканирование открытых портов
   - `dns_monitor.py` - мониторинг DNS-записей
   - `security_headers.py` - проверка заголовков безопасности веб-сайтов

2. **Ядро системы** - обеспечивает работу всех компонентов:
   - `database.py` - взаимодействие с базой данных
   - `notification.py` - отправка уведомлений по различным каналам
   - `scheduler.py` - планирование и выполнение задач

3. **Веб-интерфейс** - предоставляет пользовательский интерфейс для управления системой:
   - `app.py` - Flask-приложение
   - Шаблоны и статические файлы

## Поток данных в системе

1. **Сбор данных**:
   - Модули мониторинга собирают данные о состоянии объектов (IP, сайты, сертификаты и т.д.)
   - Данные предварительно обрабатываются и структурируются

2. **Анализ изменений**:
   - Система сравнивает полученные данные с сохраненными ранее
   - При обнаружении изменений формируются события и уведомления

3. **Хранение данных**:
   - Все собранные данные и результаты анализа сохраняются в базе данных
   - История изменений также сохраняется для последующего анализа

4. **Уведомления**:
   - При обнаружении критических изменений система отправляет уведомления
   - Поддерживаются различные каналы уведомлений (email, Slack, Telegram и др.)

5. **Визуализация**:
   - Все данные доступны через веб-интерфейс
   - Предоставляется агрегированная статистика и детальные отчеты

## API системы

### Модуль IP-сканирования (modules/ip_scanner.py)

```python
class IPScanner:
    def __init__(self, db_manager, notification_manager):
        """
        Инициализация сканера IP-адресов.
        
        :param db_manager: Менеджер базы данных
        :param notification_manager: Менеджер уведомлений
        """
        
    def scan_ip(self, ip_address):
        """
        Сканирование отдельного IP-адреса.
        
        :param ip_address: IP-адрес для сканирования
        :return: Словарь с результатами сканирования
        """
        
    def scan_ip_range(self, ip_range):
        """
        Сканирование диапазона IP-адресов.
        
        :param ip_range: Строка с диапазоном IP-адресов (CIDR или начало-конец)
        :return: Словарь с результатами сканирования
        """
        
    def detect_changes(self, ip_address, scan_results):
        """
        Определение изменений для IP-адреса.
        
        :param ip_address: IP-адрес
        :param scan_results: Результаты текущего сканирования
        :return: Список обнаруженных изменений
        """
```

### Модуль мониторинга веб-сайтов (modules/website_monitor.py)

```python
class WebsiteMonitor:
    def __init__(self, db_manager, notification_manager):
        """
        Инициализация монитора веб-сайтов.
        
        :param db_manager: Менеджер базы данных
        :param notification_manager: Менеджер уведомлений
        """
        
    def check_website(self, url, check_content=True):
        """
        Проверка доступности и состояния веб-сайта.
        
        :param url: URL веб-сайта
        :param check_content: Флаг проверки содержимого
        :return: Словарь с результатами проверки
        """
        
    def detect_changes(self, url, check_results):
        """
        Определение изменений на веб-сайте.
        
        :param url: URL веб-сайта
        :param check_results: Результаты текущей проверки
        :return: Список обнаруженных изменений
        """
```

### Модуль проверки сертификатов (modules/cert_checker.py)

```python
class CertificateChecker:
    def __init__(self, db_manager, notification_manager):
        """
        Инициализация проверки сертификатов.
        
        :param db_manager: Менеджер базы данных
        :param notification_manager: Менеджер уведомлений
        """
        
    def check_certificate(self, hostname, port=443):
        """
        Проверка SSL-сертификата.
        
        :param hostname: Имя хоста
        :param port: Порт (по умолчанию 443)
        :return: Словарь с информацией о сертификате
        """
        
    def is_expiring_soon(self, cert_info, warning_days=30):
        """
        Проверка, истекает ли сертификат в ближайшее время.
        
        :param cert_info: Информация о сертификате
        :param warning_days: Количество дней для предупреждения
        :return: True, если сертификат скоро истекает, иначе False
        """
```

### Модуль базы данных (core/database.py)

```python
class DatabaseManager:
    def __init__(self, db_uri):
        """
        Инициализация менеджера базы данных.
        
        :param db_uri: URI для подключения к базе данных
        """
        
    def save_ip_scan(self, ip_address, scan_results):
        """
        Сохранение результатов сканирования IP.
        
        :param ip_address: IP-адрес
        :param scan_results: Результаты сканирования
        """
        
    def save_website_check(self, url, check_results):
        """
        Сохранение результатов проверки веб-сайта.
        
        :param url: URL веб-сайта
        :param check_results: Результаты проверки
        """
        
    def save_certificate_check(self, hostname, cert_info):
        """
        Сохранение информации о сертификате.
        
        :param hostname: Имя хоста
        :param cert_info: Информация о сертификате
        """
        
    def get_ip_history(self, ip_address, limit=10):
        """
        Получение истории сканирования IP.
        
        :param ip_address: IP-адрес
        :param limit: Ограничение количества записей
        :return: Список записей истории
        """
        
    # Аналогичные методы для других объектов мониторинга
```

### Модуль уведомлений (core/notification.py)

```python
class NotificationManager:
    def __init__(self, config):
        """
        Инициализация менеджера уведомлений.
        
        :param config: Конфигурация каналов уведомлений
        """
        
    def send_notification(self, message, severity="info", channels=None):
        """
        Отправка уведомления.
        
        :param message: Текст уведомления
        :param severity: Серьезность уведомления (info, warning, critical)
        :param channels: Список каналов для отправки (None - все настроенные)
        """
        
    def send_email(self, recipients, subject, body):
        """
        Отправка уведомления по email.
        
        :param recipients: Список получателей
        :param subject: Тема письма
        :param body: Текст письма
        """
        
    def send_slack(self, message):
        """
        Отправка уведомления в Slack.
        
        :param message: Текст уведомления
        """
        
    def send_telegram(self, message):
        """
        Отправка уведомления в Telegram.
        
        :param message: Текст уведомления
        """
```

### Модуль планировщика (core/scheduler.py)

```python
class SchedulerManager:
    def __init__(self):
        """
        Инициализация менеджера планирования задач.
        """
        
    def start(self):
        """
        Запуск планировщика.
        """
        
    def shutdown(self):
        """
        Остановка планировщика.
        """
        
    def add_job(self, job_function, interval_minutes, job_id=None, args=None, kwargs=None):
        """
        Добавление задачи в планировщик.
        
        :param job_function: Функция для выполнения
        :param interval_minutes: Интервал выполнения в минутах
        :param job_id: Идентификатор задачи
        :param args: Аргументы функции
        :param kwargs: Именованные аргументы функции
        :return: Идентификатор задачи
        """
        
    def remove_job(self, job_id):
        """
        Удаление задачи из планировщика.
        
        :param job_id: Идентификатор задачи
        :return: True в случае успеха, иначе False
        """
        
    def modify_job(self, job_id, interval_minutes=None):
        """
        Изменение параметров задачи.
        
        :param job_id: Идентификатор задачи
        :param interval_minutes: Новый интервал выполнения в минутах
        :return: True в случае успеха, иначе False
        """
```

## Веб-интерфейс (dashboard/app.py)

Веб-интерфейс предоставляет удобный доступ к системе мониторинга и включает следующие основные страницы:

1. **Главная панель** - обзор всех мониторируемых объектов и их статуса
2. **Настройка мониторинга** - добавление и настройка объектов мониторинга
3. **Отчеты** - просмотр истории мониторинга и генерация отчетов
4. **Уведомления** - настройка каналов и правил уведомлений
5. **Настройки** - общие настройки системы

## Рекомендации по развертыванию

### Требования к системе

- Python 3.9+
- База данных (SQLite, MySQL или PostgreSQL)
- Доступ к сети интернет
- Для работы модуля `port_scanner.py` может потребоваться установка дополнительных системных пакетов (nmap)

### Безопасность

При развертывании системы рекомендуется:

1. Запускать сервис от имени непривилегированного пользователя
2. Ограничить доступ к веб-интерфейсу с помощью SSL и базовой аутентификации
3. Регулярно обновлять зависимости
4. Использовать безопасные параметры подключения к базе данных
5. Хранить конфиденциальные данные (токены API, пароли) в переменных окружения, а не в конфигурационных файлах

### Масштабирование

Для мониторинга большого количества объектов рекомендуется:

1. Использовать производительную базу данных (PostgreSQL)
2. Разделить нагрузку на несколько серверов
3. Использовать кэширование для часто запрашиваемых данных
4. Настроить пулы подключений к базе данных
5. Оптимизировать запросы к базе данных

## Расширение системы

### Добавление новых модулей мониторинга

Для добавления нового модуля мониторинга:

1. Создайте новый файл в директории `modules/`
2. Реализуйте класс с методами `check()` и `detect_changes()`
3. Добавьте соответствующие методы в `DatabaseManager` для хранения результатов
4. Зарегистрируйте модуль в `main.py`
5. Добавьте интерфейс управления в веб-интерфейс

### Интеграция с внешними системами

Система поддерживает интеграцию с внешними системами через:

1. API для получения данных мониторинга
2. Hooks для подключения к событиям системы
3. Экспорт данных в различных форматах
4. Поддержку различных протоколов уведомлений